<!DOCTYPE html>

<html>
<head>
  <title>marionette-threejs.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>marionette-threejs.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>marionette-threejs - v0.0.2</p>
<p><a href="https://github.com/Stonelinks/marionette-threejs">https://github.com/Stonelinks/marionette-threejs</a></p>
<p>Simple wrappers around three.js components using Backbone.Marionette</p>
<p>Copyright (c)2014 - Lucas Doyle <a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#x6f;&#x3a;&#108;&#117;&#99;&#x61;&#x73;&#x2e;&#112;&#x2e;&#100;&#111;&#x79;&#108;&#101;&#x40;&#x67;&#109;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;">&#108;&#117;&#99;&#x61;&#x73;&#x2e;&#112;&#x2e;&#100;&#111;&#x79;&#108;&#101;&#x40;&#x67;&#109;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;</a></p>
<p>Distributed under MIT license</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>


(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(root, factory)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Set up m3js appropriately for the environment. Start with AMD.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
    define([<span class="hljs-string">'backbone'</span>, <span class="hljs-string">'exports'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone, exports)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Export global even in AMD case in case this script is loaded with
others that may still expect a global m3js.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      root.m3js = factory(root, exports, Backbone);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Next for Node.js or CommonJS. jQuery may not be needed as a module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> exports !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">var</span> Backbone = <span class="hljs-built_in">require</span>(<span class="hljs-string">'backbone'</span>);
    factory(root, exports, Backbone);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Finally, as a browser global.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  <span class="hljs-keyword">else</span> {
    root.m3js = factory(root, {}, root.Backbone);
  }

}(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(root, m3js, Backbone)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1 id="bundle-modified-threejs-controls">Bundle modified threejs controls</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/**
   * @author qiao / https://github.com/qiao
   * @author mrdoob / http://mrdoob.com
   * @author alteredq / http://alteredqualia.com/
   * @author WestLangley / http://github.com/WestLangley
   * @author erich666 / http://erichaines.com
   */</span>
  <span class="hljs-comment">/*global THREE, console */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This set of controls performs orbiting, dollying (zooming), and panning. It maintains
the “up” direction as +Y, unlike the TrackballControls. Touch on tablet and phones is
supported.</p>
<p>   Orbit - left mouse / touch: one finger move
   Zoom - middle mouse, or mousewheel / touch: two finger spread or squish
   Pan - right mouse, or arrow keys / touch: three finter swipe</p>
<p>This is a drop-in replacement for (most) TrackballControls used in examples.
That is, include this js file and wherever you see:
       controls = new THREE.TrackballControls( camera );
     controls.target.z = 150;
Simple substitute “OrbitControls” and the control should work as-is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  THREE.OrbitControls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object, domElement)</span> </span>{
  
    <span class="hljs-keyword">this</span>.object = object;
    <span class="hljs-keyword">this</span>.domElement = (domElement !== <span class="hljs-literal">undefined</span>) ? domElement : <span class="hljs-built_in">document</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>API</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set to false to disable this control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.enabled = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>“target” sets the location of focus, where the control orbits around
and where it pans with respect to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.target = <span class="hljs-keyword">new</span> THREE.Vector3();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>center is old, deprecated; use “target” instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.center = <span class="hljs-keyword">this</span>.target;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>This option actually enables dollying in and out; left as “zoom” for
backwards compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.noZoom = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.zoomSpeed = <span class="hljs-number">1.0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Limits to how far you can dolly in and out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.minDistance = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.maxDistance = <span class="hljs-literal">Infinity</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Set to true to disable this control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.noRotate = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.rotateSpeed = <span class="hljs-number">1.0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Set to true to disable this control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.noPan = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.keyPanSpeed = <span class="hljs-number">7.0</span>; <span class="hljs-comment">// pixels moved per arrow key push</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Set to true to automatically rotate around the target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.autoRotate = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.autoRotateSpeed = <span class="hljs-number">2.0</span>; <span class="hljs-comment">// 30 seconds per round when fps is 60</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>How far you can orbit vertically, upper and lower limits.
Range is 0 to Math.PI radians.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.minPolarAngle = <span class="hljs-number">0</span>; <span class="hljs-comment">// radians</span>
    <span class="hljs-keyword">this</span>.maxPolarAngle = <span class="hljs-built_in">Math</span>.PI; <span class="hljs-comment">// radians</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set to true to disable use of the keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.noKeys = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>The four arrow keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.keys = {
      LEFT: <span class="hljs-number">37</span>,
      UP: <span class="hljs-number">38</span>,
      RIGHT: <span class="hljs-number">39</span>,
      BOTTOM: <span class="hljs-number">40</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>//////////
internals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
  
    <span class="hljs-keyword">var</span> EPS = <span class="hljs-number">0.000001</span>;
  
    <span class="hljs-keyword">var</span> rotateStart = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> rotateEnd = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> rotateDelta = <span class="hljs-keyword">new</span> THREE.Vector2();
  
    <span class="hljs-keyword">var</span> panStart = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> panEnd = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> panDelta = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> panOffset = <span class="hljs-keyword">new</span> THREE.Vector3();
  
    <span class="hljs-keyword">var</span> offset = <span class="hljs-keyword">new</span> THREE.Vector3();
  
    <span class="hljs-keyword">var</span> dollyStart = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> dollyEnd = <span class="hljs-keyword">new</span> THREE.Vector2();
    <span class="hljs-keyword">var</span> dollyDelta = <span class="hljs-keyword">new</span> THREE.Vector2();
  
    <span class="hljs-keyword">var</span> phiDelta = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> thetaDelta = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> scale = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> pan = <span class="hljs-keyword">new</span> THREE.Vector3();
  
    <span class="hljs-keyword">var</span> lastPosition = <span class="hljs-keyword">new</span> THREE.Vector3();
    <span class="hljs-keyword">var</span> lastQuaternion = <span class="hljs-keyword">new</span> THREE.Quaternion();
  
    <span class="hljs-keyword">var</span> STATE = {
      NONE: -<span class="hljs-number">1</span>,
      ROTATE: <span class="hljs-number">0</span>,
      DOLLY: <span class="hljs-number">1</span>,
      PAN: <span class="hljs-number">2</span>,
      TOUCH_ROTATE: <span class="hljs-number">3</span>,
      TOUCH_DOLLY: <span class="hljs-number">4</span>,
      TOUCH_PAN: <span class="hljs-number">5</span>
    };
  
    <span class="hljs-keyword">var</span> state = STATE.NONE;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>for reset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
    <span class="hljs-keyword">this</span>.target0 = <span class="hljs-keyword">this</span>.target.clone();
    <span class="hljs-keyword">this</span>.position0 = <span class="hljs-keyword">this</span>.object.position.clone();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>so camera.up is the orbit axis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
    <span class="hljs-keyword">var</span> quat = <span class="hljs-keyword">new</span> THREE.Quaternion().setFromUnitVectors(object.up, <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>));
    <span class="hljs-keyword">var</span> quatInverse = quat.clone().inverse();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
    <span class="hljs-keyword">var</span> changeEvent = {
      type: <span class="hljs-string">'change'</span>
    };
    <span class="hljs-keyword">var</span> startEvent = {
      type: <span class="hljs-string">'start'</span>
    };
    <span class="hljs-keyword">var</span> endEvent = {
      type: <span class="hljs-string">'end'</span>
    };
  
    <span class="hljs-keyword">this</span>.rotateLeft = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(angle)</span> </span>{
  
      <span class="hljs-keyword">if</span> (angle === <span class="hljs-literal">undefined</span>) {
  
        angle = getAutoRotationAngle();
  
      }
  
      thetaDelta -= angle;
  
    };
  
    <span class="hljs-keyword">this</span>.rotateUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(angle)</span> </span>{
  
      <span class="hljs-keyword">if</span> (angle === <span class="hljs-literal">undefined</span>) {
  
        angle = getAutoRotationAngle();
  
      }
  
      phiDelta -= angle;
  
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>pass in distance in world space to move left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.panLeft = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(distance)</span> </span>{
  
      <span class="hljs-keyword">var</span> te = <span class="hljs-keyword">this</span>.object.matrix.elements;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>get X column of matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      panOffset.set(te[<span class="hljs-number">0</span>], te[<span class="hljs-number">1</span>], te[<span class="hljs-number">2</span>]);
      panOffset.multiplyScalar(-distance);
  
      pan.add(panOffset);
  
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>pass in distance in world space to move up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.panUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(distance)</span> </span>{
  
      <span class="hljs-keyword">var</span> te = <span class="hljs-keyword">this</span>.object.matrix.elements;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>get Y column of matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      panOffset.set(te[<span class="hljs-number">4</span>], te[<span class="hljs-number">5</span>], te[<span class="hljs-number">6</span>]);
      panOffset.multiplyScalar(distance);
  
      pan.add(panOffset);
  
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>pass in x,y of change desired in pixel space,
right and down are positive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.pan = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deltaX, deltaY)</span> </span>{
  
      <span class="hljs-keyword">var</span> element = scope.domElement === <span class="hljs-built_in">document</span> ? scope.domElement.body : scope.domElement;
  
      <span class="hljs-keyword">if</span> (scope.object.fov !== <span class="hljs-literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>perspective</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> position = scope.object.position;
        <span class="hljs-keyword">var</span> offset = position.clone().sub(scope.target);
        <span class="hljs-keyword">var</span> targetDistance = offset.length();</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>half of the fov is center to top of screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        targetDistance *= <span class="hljs-built_in">Math</span>.tan((scope.object.fov / <span class="hljs-number">2</span>) * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180.0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>we actually don’t use screenWidth, since perspective camera is fixed to screen height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scope.panLeft(<span class="hljs-number">2</span> * deltaX * targetDistance / element.clientHeight);
        scope.panUp(<span class="hljs-number">2</span> * deltaY * targetDistance / element.clientHeight);
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.object.top !== <span class="hljs-literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>orthographic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scope.panLeft(deltaX * (scope.object.right - scope.object.left) / element.clientWidth);
        scope.panUp(deltaY * (scope.object.top - scope.object.bottom) / element.clientHeight);
  
      }
      <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>camera neither orthographic or perspective</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.'</span>);
  
      }
  
    };
  
    <span class="hljs-keyword">this</span>.dollyIn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dollyScale)</span> </span>{
  
      <span class="hljs-keyword">if</span> (dollyScale === <span class="hljs-literal">undefined</span>) {
  
        dollyScale = getZoomScale();
  
      }
  
      scale /= dollyScale;
  
    };
  
    <span class="hljs-keyword">this</span>.dollyOut = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dollyScale)</span> </span>{
  
      <span class="hljs-keyword">if</span> (dollyScale === <span class="hljs-literal">undefined</span>) {
  
        dollyScale = getZoomScale();
  
      }
  
      scale *= dollyScale;
  
    };
  
    <span class="hljs-keyword">this</span>.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">var</span> position = <span class="hljs-keyword">this</span>.object.position;
  
      offset.copy(position).sub(<span class="hljs-keyword">this</span>.target);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>rotate offset to “y-axis-is-up” space</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      offset.applyQuaternion(quat);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>angle from z-axis around y-axis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
      <span class="hljs-keyword">var</span> theta = <span class="hljs-built_in">Math</span>.atan2(offset.x, offset.z);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>angle from y-axis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
      <span class="hljs-keyword">var</span> phi = <span class="hljs-built_in">Math</span>.atan2(<span class="hljs-built_in">Math</span>.sqrt(offset.x * offset.x + offset.z * offset.z), offset.y);
  
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.autoRotate) {
  
        <span class="hljs-keyword">this</span>.rotateLeft(getAutoRotationAngle());
  
      }
  
      theta += thetaDelta;
      phi += phiDelta;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>restrict phi to be between desired limits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      phi = <span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.minPolarAngle, <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.maxPolarAngle, phi));</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>restrict phi to be betwee EPS and PI-EPS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      phi = <span class="hljs-built_in">Math</span>.max(EPS, <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">Math</span>.PI - EPS, phi));
  
      <span class="hljs-keyword">var</span> radius = offset.length() * scale;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>restrict radius to be between desired limits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      radius = <span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.minDistance, <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.maxDistance, radius));</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>move target to panned location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.target.add(pan);
  
      offset.x = radius * <span class="hljs-built_in">Math</span>.sin(phi) * <span class="hljs-built_in">Math</span>.sin(theta);
      offset.y = radius * <span class="hljs-built_in">Math</span>.cos(phi);
      offset.z = radius * <span class="hljs-built_in">Math</span>.sin(phi) * <span class="hljs-built_in">Math</span>.cos(theta);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>rotate offset back to “camera-up-vector-is-up” space</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      offset.applyQuaternion(quatInverse);
  
      position.copy(<span class="hljs-keyword">this</span>.target).add(offset);
  
      <span class="hljs-keyword">this</span>.object.lookAt(<span class="hljs-keyword">this</span>.target);
  
      thetaDelta = <span class="hljs-number">0</span>;
      phiDelta = <span class="hljs-number">0</span>;
      scale = <span class="hljs-number">1</span>;
      pan.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>update condition is:
min(camera displacement, camera rotation in radians)^2 &gt; EPS
using small-angle approximation cos(x/2) = 1 - x^2 / 8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
      <span class="hljs-keyword">if</span> (lastPosition.distanceToSquared(<span class="hljs-keyword">this</span>.object.position) &gt; EPS || <span class="hljs-number">8</span> * (<span class="hljs-number">1</span> - lastQuaternion.dot(<span class="hljs-keyword">this</span>.object.quaternion)) &gt; EPS) {
  
        <span class="hljs-keyword">this</span>.dispatchEvent(changeEvent);
  
        lastPosition.copy(<span class="hljs-keyword">this</span>.object.position);
        lastQuaternion.copy(<span class="hljs-keyword">this</span>.object.quaternion);
  
      }
  
    };
  
  
    <span class="hljs-keyword">this</span>.reset = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      state = STATE.NONE;
  
      <span class="hljs-keyword">this</span>.target.copy(<span class="hljs-keyword">this</span>.target0);
      <span class="hljs-keyword">this</span>.object.position.copy(<span class="hljs-keyword">this</span>.position0);
  
      <span class="hljs-keyword">this</span>.update();
  
    };
  
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAutoRotationAngle</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> * scope.autoRotateSpeed;
  
    }
  
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getZoomScale</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">0.95</span>, scope.zoomSpeed);
  
    }
  
    <span class="hljs-keyword">this</span>.onMouseDown = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
      event.preventDefault();
  
      <span class="hljs-keyword">if</span> (event.button === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (scope.noRotate === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        state = STATE.ROTATE;
  
        rotateStart.set(event.clientX, event.clientY);
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.button === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (scope.noZoom === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        state = STATE.DOLLY;
  
        dollyStart.set(event.clientX, event.clientY);
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.button === <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">if</span> (scope.noPan === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        state = STATE.PAN;
  
        panStart.set(event.clientX, event.clientY);
  
      }
  
      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mousemove'</span>, scope.onMouseMove, <span class="hljs-literal">false</span>);
      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mouseup'</span>, scope.onMouseUp, <span class="hljs-literal">false</span>);
      scope.dispatchEvent(startEvent);
  
    };
  
    <span class="hljs-keyword">this</span>.onMouseMove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
      event.preventDefault();
  
      <span class="hljs-keyword">var</span> element = scope.domElement === <span class="hljs-built_in">document</span> ? scope.domElement.body : scope.domElement;
  
      <span class="hljs-keyword">if</span> (state === STATE.ROTATE) {
  
        <span class="hljs-keyword">if</span> (scope.noRotate === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        rotateEnd.set(event.clientX, event.clientY);
        rotateDelta.subVectors(rotateEnd, rotateStart);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>rotating across whole screen goes 360 degrees around</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scope.rotateLeft(<span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>rotating up and down along whole screen attempts to go 360, but limited to 180</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scope.rotateUp(<span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed);
  
        rotateStart.copy(rotateEnd);
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === STATE.DOLLY) {
  
        <span class="hljs-keyword">if</span> (scope.noZoom === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        dollyEnd.set(event.clientX, event.clientY);
        dollyDelta.subVectors(dollyEnd, dollyStart);
  
        <span class="hljs-keyword">if</span> (dollyDelta.y &gt; <span class="hljs-number">0</span>) {
  
          scope.dollyIn();
  
        }
        <span class="hljs-keyword">else</span> {
  
          scope.dollyOut();
  
        }
  
        dollyStart.copy(dollyEnd);
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === STATE.PAN) {
  
        <span class="hljs-keyword">if</span> (scope.noPan === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        panEnd.set(event.clientX, event.clientY);
        panDelta.subVectors(panEnd, panStart);
  
        scope.pan(panDelta.x, panDelta.y);
  
        panStart.copy(panEnd);
  
      }
  
      scope.update();
  
    };
  
    <span class="hljs-keyword">this</span>.onMouseUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* event */</span> )</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
      <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'mousemove'</span>, scope.onMouseMove, <span class="hljs-literal">false</span>);
      <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'mouseup'</span>, scope.onMouseUp, <span class="hljs-literal">false</span>);
      scope.dispatchEvent(endEvent);
      state = STATE.NONE;
  
    };
  
    <span class="hljs-keyword">this</span>.onMouseWheel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span> || scope.noZoom === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
      event.preventDefault();
      event.stopPropagation();
  
      <span class="hljs-keyword">var</span> delta = <span class="hljs-number">0</span>;
  
      <span class="hljs-keyword">if</span> (event.wheelDelta !== <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// WebKit / Opera / Explorer 9</span>
  
        delta = event.wheelDelta;
  
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.detail !== <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// Firefox</span>
  
        delta = -event.detail;
  
      }
  
      <span class="hljs-keyword">if</span> (delta &gt; <span class="hljs-number">0</span>) {
  
        scope.dollyOut();
  
      }
      <span class="hljs-keyword">else</span> {
  
        scope.dollyIn();
  
      }
  
      scope.update();
      scope.dispatchEvent(startEvent);
      scope.dispatchEvent(endEvent);
  
    };
  
    <span class="hljs-keyword">this</span>.onKeyDown = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span> || scope.noKeys === <span class="hljs-literal">true</span> || scope.noPan === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
      <span class="hljs-keyword">switch</span> (event.keyCode) {
  
        <span class="hljs-keyword">case</span> scope.keys.UP:
          scope.pan(<span class="hljs-number">0</span>, scope.keyPanSpeed);
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> scope.keys.BOTTOM:
          scope.pan(<span class="hljs-number">0</span>, -scope.keyPanSpeed);
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> scope.keys.LEFT:
          scope.pan(scope.keyPanSpeed, <span class="hljs-number">0</span>);
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> scope.keys.RIGHT:
          scope.pan(-scope.keyPanSpeed, <span class="hljs-number">0</span>);
          scope.update();
          <span class="hljs-keyword">break</span>;
  
      }
  
    };
  
    <span class="hljs-keyword">this</span>.touchstart = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
      <span class="hljs-keyword">switch</span> (event.touches.length) {
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// one-fingered touch: rotate</span>
  
          <span class="hljs-keyword">if</span> (scope.noRotate === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
          state = STATE.TOUCH_ROTATE;
  
          rotateStart.set(event.touches[<span class="hljs-number">0</span>].pageX, event.touches[<span class="hljs-number">0</span>].pageY);
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// two-fingered touch: dolly</span>
  
          <span class="hljs-keyword">if</span> (scope.noZoom === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
          state = STATE.TOUCH_DOLLY;
  
          <span class="hljs-keyword">var</span> dx = event.touches[<span class="hljs-number">0</span>].pageX - event.touches[<span class="hljs-number">1</span>].pageX;
          <span class="hljs-keyword">var</span> dy = event.touches[<span class="hljs-number">0</span>].pageY - event.touches[<span class="hljs-number">1</span>].pageY;
          <span class="hljs-keyword">var</span> distance = <span class="hljs-built_in">Math</span>.sqrt(dx * dx + dy * dy);
          dollyStart.set(<span class="hljs-number">0</span>, distance);
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// three-fingered touch: pan</span>
  
          <span class="hljs-keyword">if</span> (scope.noPan === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
          state = STATE.TOUCH_PAN;
  
          panStart.set(event.touches[<span class="hljs-number">0</span>].pageX, event.touches[<span class="hljs-number">0</span>].pageY);
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">default</span>:
  
          state = STATE.NONE;
  
      }
  
      scope.dispatchEvent(startEvent);
  
    };
  
    <span class="hljs-keyword">this</span>.touchmove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
      event.preventDefault();
      event.stopPropagation();
  
      <span class="hljs-keyword">var</span> element = scope.domElement === <span class="hljs-built_in">document</span> ? scope.domElement.body : scope.domElement;
  
      <span class="hljs-keyword">switch</span> (event.touches.length) {
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// one-fingered touch: rotate</span>
  
          <span class="hljs-keyword">if</span> (scope.noRotate === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">if</span> (state !== STATE.TOUCH_ROTATE) <span class="hljs-keyword">return</span>;
  
          rotateEnd.set(event.touches[<span class="hljs-number">0</span>].pageX, event.touches[<span class="hljs-number">0</span>].pageY);
          rotateDelta.subVectors(rotateEnd, rotateStart);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>rotating across whole screen goes 360 degrees around</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          scope.rotateLeft(<span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>rotating up and down along whole screen attempts to go 360, but limited to 180</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          scope.rotateUp(<span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed);
  
          rotateStart.copy(rotateEnd);
  
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// two-fingered touch: dolly</span>
  
          <span class="hljs-keyword">if</span> (scope.noZoom === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">if</span> (state !== STATE.TOUCH_DOLLY) <span class="hljs-keyword">return</span>;
  
          <span class="hljs-keyword">var</span> dx = event.touches[<span class="hljs-number">0</span>].pageX - event.touches[<span class="hljs-number">1</span>].pageX;
          <span class="hljs-keyword">var</span> dy = event.touches[<span class="hljs-number">0</span>].pageY - event.touches[<span class="hljs-number">1</span>].pageY;
          <span class="hljs-keyword">var</span> distance = <span class="hljs-built_in">Math</span>.sqrt(dx * dx + dy * dy);
  
          dollyEnd.set(<span class="hljs-number">0</span>, distance);
          dollyDelta.subVectors(dollyEnd, dollyStart);
  
          <span class="hljs-keyword">if</span> (dollyDelta.y &gt; <span class="hljs-number">0</span>) {
  
            scope.dollyOut();
  
          }
          <span class="hljs-keyword">else</span> {
  
            scope.dollyIn();
  
          }
  
          dollyStart.copy(dollyEnd);
  
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// three-fingered touch: pan</span>
  
          <span class="hljs-keyword">if</span> (scope.noPan === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">if</span> (state !== STATE.TOUCH_PAN) <span class="hljs-keyword">return</span>;
  
          panEnd.set(event.touches[<span class="hljs-number">0</span>].pageX, event.touches[<span class="hljs-number">0</span>].pageY);
          panDelta.subVectors(panEnd, panStart);
  
          scope.pan(panDelta.x, panDelta.y);
  
          panStart.copy(panEnd);
  
          scope.update();
          <span class="hljs-keyword">break</span>;
  
        <span class="hljs-keyword">default</span>:
  
          state = STATE.NONE;
  
      }
  
    };
  
    <span class="hljs-keyword">this</span>.touchend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* event */</span> )</span> </span>{
  
      <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
      scope.dispatchEvent(endEvent);
      state = STATE.NONE;
  
    };
  
    <span class="hljs-keyword">this</span>.onContextMenu = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
      event.preventDefault();
  
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>this.domElement.addEventListener( ‘contextmenu’, onContextMenu, false );
this.domElement.addEventListener( ‘mousedown’, onMouseDown, false );
this.domElement.addEventListener( ‘mousewheel’, onMouseWheel, false );
this.domElement.addEventListener( ‘DOMMouseScroll’, onMouseWheel, false ); // firefox</p>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>this.domElement.addEventListener( ‘touchstart’, touchstart, false );
this.domElement.addEventListener( ‘touchend’, touchend, false );
this.domElement.addEventListener( ‘touchmove’, touchmove, false );</p>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>window.addEventListener( ‘keydown’, onKeyDown, false );</p>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>force an update at start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.update();
  
  };
  
  THREE.OrbitControls.prototype = <span class="hljs-built_in">Object</span>.create(THREE.EventDispatcher.prototype);
  
  <span class="hljs-comment">/**
   * @author arodic / https://github.com/arodic
   */</span>
  <span class="hljs-comment">/*jshint sub:true*/</span>
  
  (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
<span class="hljs-pi">  
    'use strict'</span>;
  
    <span class="hljs-keyword">var</span> GizmoMaterial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parameters)</span> </span>{
  
      THREE.MeshBasicMaterial.call(<span class="hljs-keyword">this</span>);
  
      <span class="hljs-keyword">this</span>.depthTest = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.depthWrite = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.side = THREE.FrontSide;
      <span class="hljs-keyword">this</span>.transparent = <span class="hljs-literal">true</span>;
  
      <span class="hljs-keyword">this</span>.setValues(parameters);
  
      <span class="hljs-keyword">this</span>.oldColor = <span class="hljs-keyword">this</span>.color.clone();
      <span class="hljs-keyword">this</span>.oldOpacity = <span class="hljs-keyword">this</span>.opacity;
  
      <span class="hljs-keyword">this</span>.highlight = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(highlighted)</span> </span>{
  
        <span class="hljs-keyword">if</span> (highlighted) {
  
          <span class="hljs-keyword">this</span>.color.setRGB(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
          <span class="hljs-keyword">this</span>.opacity = <span class="hljs-number">1</span>;
  
        }
        <span class="hljs-keyword">else</span> {
  
          <span class="hljs-keyword">this</span>.color.copy(<span class="hljs-keyword">this</span>.oldColor);
          <span class="hljs-keyword">this</span>.opacity = <span class="hljs-keyword">this</span>.oldOpacity;
  
        }
  
      };
  
    };
  
    GizmoMaterial.prototype = <span class="hljs-built_in">Object</span>.create(THREE.MeshBasicMaterial.prototype);
  
    <span class="hljs-keyword">var</span> GizmoLineMaterial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parameters)</span> </span>{
  
      THREE.LineBasicMaterial.call(<span class="hljs-keyword">this</span>);
  
      <span class="hljs-keyword">this</span>.depthTest = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.depthWrite = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.transparent = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.linewidth = <span class="hljs-number">1</span>;
  
      <span class="hljs-keyword">this</span>.setValues(parameters);
  
      <span class="hljs-keyword">this</span>.oldColor = <span class="hljs-keyword">this</span>.color.clone();
      <span class="hljs-keyword">this</span>.oldOpacity = <span class="hljs-keyword">this</span>.opacity;
  
      <span class="hljs-keyword">this</span>.highlight = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(highlighted)</span> </span>{
  
        <span class="hljs-keyword">if</span> (highlighted) {
  
          <span class="hljs-keyword">this</span>.color.setRGB(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
          <span class="hljs-keyword">this</span>.opacity = <span class="hljs-number">1</span>;
  
        }
        <span class="hljs-keyword">else</span> {
  
          <span class="hljs-keyword">this</span>.color.copy(<span class="hljs-keyword">this</span>.oldColor);
          <span class="hljs-keyword">this</span>.opacity = <span class="hljs-keyword">this</span>.oldOpacity;
  
        }
  
      };
  
    };
  
    GizmoLineMaterial.prototype = <span class="hljs-built_in">Object</span>.create(THREE.LineBasicMaterial.prototype);
  
    THREE.TransformGizmo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> showPickers = <span class="hljs-literal">false</span>; <span class="hljs-comment">//debug</span>
      <span class="hljs-keyword">var</span> showActivePlane = <span class="hljs-literal">false</span>; <span class="hljs-comment">//debug</span>
  
      <span class="hljs-keyword">this</span>.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
        THREE.Object3D.call(<span class="hljs-keyword">this</span>);
  
        <span class="hljs-keyword">this</span>.handles = <span class="hljs-keyword">new</span> THREE.Object3D();
        <span class="hljs-keyword">this</span>.pickers = <span class="hljs-keyword">new</span> THREE.Object3D();
        <span class="hljs-keyword">this</span>.planes = <span class="hljs-keyword">new</span> THREE.Object3D();
  
        <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.handles);
        <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.pickers);
        <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.planes);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>// PLANES</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
        <span class="hljs-keyword">var</span> planeGeometry = <span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
        <span class="hljs-keyword">var</span> planeMaterial = <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial({
          wireframe: <span class="hljs-literal">true</span>
        });
        planeMaterial.side = THREE.DoubleSide;
  
        <span class="hljs-keyword">var</span> planes = {
          <span class="hljs-string">'XY'</span>: <span class="hljs-keyword">new</span> THREE.Mesh(planeGeometry, planeMaterial),
          <span class="hljs-string">'YZ'</span>: <span class="hljs-keyword">new</span> THREE.Mesh(planeGeometry, planeMaterial),
          <span class="hljs-string">'XZ'</span>: <span class="hljs-keyword">new</span> THREE.Mesh(planeGeometry, planeMaterial),
          <span class="hljs-string">'XYZE'</span>: <span class="hljs-keyword">new</span> THREE.Mesh(planeGeometry, planeMaterial)
        };
  
        <span class="hljs-keyword">this</span>.activePlane = planes[<span class="hljs-string">'XYZE'</span>];
  
        planes[<span class="hljs-string">'YZ'</span>].rotation.set(<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
        planes[<span class="hljs-string">'XZ'</span>].rotation.set(-<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> planes) {
          planes[i].name = i;
          <span class="hljs-keyword">this</span>.planes.add(planes[i]);
          <span class="hljs-keyword">this</span>.planes[i] = planes[i];
          planes[i].visible = <span class="hljs-literal">false</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>// HANDLES AND PICKERS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
        <span class="hljs-keyword">var</span> setupGizmos = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(gizmoMap, parent)</span> </span>{
  
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> gizmoMap) {
  
            <span class="hljs-keyword">for</span> (i = gizmoMap[name].length; i--;) {
  
              <span class="hljs-keyword">var</span> object = gizmoMap[name][i][<span class="hljs-number">0</span>];
              <span class="hljs-keyword">var</span> position = gizmoMap[name][i][<span class="hljs-number">1</span>];
              <span class="hljs-keyword">var</span> rotation = gizmoMap[name][i][<span class="hljs-number">2</span>];
  
              object.name = name;
  
              <span class="hljs-keyword">if</span> (position) object.position.set(position[<span class="hljs-number">0</span>], position[<span class="hljs-number">1</span>], position[<span class="hljs-number">2</span>]);
              <span class="hljs-keyword">if</span> (rotation) object.rotation.set(rotation[<span class="hljs-number">0</span>], rotation[<span class="hljs-number">1</span>], rotation[<span class="hljs-number">2</span>]);
  
              parent.add(object);
  
            }
  
          }
  
        };
  
        setupGizmos(<span class="hljs-keyword">this</span>.handleGizmos, <span class="hljs-keyword">this</span>.handles);
        setupGizmos(<span class="hljs-keyword">this</span>.pickerGizmos, <span class="hljs-keyword">this</span>.pickers);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>reset Transformations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
        <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
          <span class="hljs-keyword">if</span> (child <span class="hljs-keyword">instanceof</span> THREE.Mesh) {
            child.updateMatrix();
  
            <span class="hljs-keyword">var</span> tempGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
            tempGeometry.merge(child.geometry, child.matrix);
  
            child.geometry = tempGeometry;
            child.position.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            child.rotation.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            child.scale.set(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
          }
        });
  
      };
  
      <span class="hljs-keyword">this</span>.hide = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
          child.visible = <span class="hljs-literal">false</span>;
        });
      };
  
      <span class="hljs-keyword">this</span>.show = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
          child.visible = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> (child.parent == scope.pickers) child.visible = showPickers;
          <span class="hljs-keyword">if</span> (child.parent == scope.planes) child.visible = <span class="hljs-literal">false</span>;
        });
        <span class="hljs-keyword">this</span>.activePlane.visible = showActivePlane;
      };
  
      <span class="hljs-keyword">this</span>.highlight = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(axis)</span> </span>{
        <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
          <span class="hljs-keyword">if</span> (child.material &amp;&amp; child.material.highlight) {
            <span class="hljs-keyword">if</span> (child.name == axis) {
              child.material.highlight(<span class="hljs-literal">true</span>);
            }
            <span class="hljs-keyword">else</span> {
              child.material.highlight(<span class="hljs-literal">false</span>);
            }
          }
        });
      };
  
    };
  
    THREE.TransformGizmo.prototype = <span class="hljs-built_in">Object</span>.create(THREE.Object3D.prototype);
  
    THREE.TransformGizmo.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rotation, eye)</span> </span>{
  
      <span class="hljs-keyword">var</span> vec1 = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> vec2 = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> lookAtMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
  
      <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
        <span class="hljs-keyword">if</span> (child.name.search(<span class="hljs-string">'E'</span>) != -<span class="hljs-number">1</span>) {
          child.quaternion.setFromRotationMatrix(lookAtMatrix.lookAt(eye, vec1, vec2));
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.name.search(<span class="hljs-string">'X'</span>) != -<span class="hljs-number">1</span> || child.name.search(<span class="hljs-string">'Y'</span>) != -<span class="hljs-number">1</span> || child.name.search(<span class="hljs-string">'Z'</span>) != -<span class="hljs-number">1</span>) {
          child.quaternion.setFromEuler(rotation);
        }
      });
  
    };
  
    THREE.TransformGizmoTranslate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      THREE.TransformGizmo.call(<span class="hljs-keyword">this</span>);
  
      <span class="hljs-keyword">var</span> arrowGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      <span class="hljs-keyword">var</span> mesh = <span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>));
      mesh.position.y = <span class="hljs-number">0.5</span>;
      mesh.updateMatrix();
  
      arrowGeometry.merge(mesh.geometry, mesh.matrix);
  
      <span class="hljs-keyword">var</span> lineXGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineXGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
  
      <span class="hljs-keyword">var</span> lineYGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineYGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>));
  
      <span class="hljs-keyword">var</span> lineZGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineZGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>));
  
      <span class="hljs-keyword">this</span>.handleGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff0000</span>
          })), [<span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineXGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0xff0000</span>
          }))]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ff00</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineYGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x00ff00</span>
          }))]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x0000ff</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>], [<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineZGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x0000ff</span>
          }))]
     ],
        XYZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.OctahedronGeometry(<span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ],
        XY: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.29</span>, <span class="hljs-number">0.29</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">0</span>]]
     ],
        YZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.29</span>, <span class="hljs-number">0.29</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>], [<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>]]
     ],
        XZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.29</span>, <span class="hljs-number">0.29</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff00ff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.15</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>], [-<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ]
      };
  
      <span class="hljs-keyword">this</span>.pickerGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff0000</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>]]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x0000ff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>], [<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ],
        XYZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.OctahedronGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          }))]
     ],
        XY: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.4</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>]]
     ],
        YZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.4</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.2</span>], [<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>]]
     ],
        XZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.PlaneGeometry(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.4</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff00ff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>], [-<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ]
      };
  
      <span class="hljs-keyword">this</span>.setActivePlane = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(axis, eye)</span> </span>{
  
        <span class="hljs-keyword">var</span> tempMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
        eye.applyMatrix4(tempMatrix.getInverse(tempMatrix.extractRotation(<span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>].matrixWorld)));
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'X'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.y) &gt; <span class="hljs-built_in">Math</span>.abs(eye.z)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Y'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.x) &gt; <span class="hljs-built_in">Math</span>.abs(eye.z)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Z'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.x) &gt; <span class="hljs-built_in">Math</span>.abs(eye.y)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'XYZ'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XYZE'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'XY'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'YZ'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'XZ'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
  
        <span class="hljs-keyword">this</span>.hide();
        <span class="hljs-keyword">this</span>.show();
  
      };
  
      <span class="hljs-keyword">this</span>.init();
  
    };
  
    THREE.TransformGizmoTranslate.prototype = <span class="hljs-built_in">Object</span>.create(THREE.TransformGizmo.prototype);
  
    THREE.TransformGizmoRotate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      THREE.TransformGizmo.call(<span class="hljs-keyword">this</span>);
  
      <span class="hljs-keyword">var</span> CircleGeometry = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(radius, facing, arc)</span> </span>{
  
        <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> THREE.Geometry();
        arc = arc ? arc : <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">64</span> * arc; ++i) {
          <span class="hljs-keyword">if</span> (facing == <span class="hljs-string">'x'</span>) geometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.cos(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI), <span class="hljs-built_in">Math</span>.sin(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI)).multiplyScalar(radius));
          <span class="hljs-keyword">if</span> (facing == <span class="hljs-string">'y'</span>) geometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-built_in">Math</span>.cos(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI), <span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.sin(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI)).multiplyScalar(radius));
          <span class="hljs-keyword">if</span> (facing == <span class="hljs-string">'z'</span>) geometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-built_in">Math</span>.sin(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI), <span class="hljs-built_in">Math</span>.cos(i / <span class="hljs-number">32</span> * <span class="hljs-built_in">Math</span>.PI), <span class="hljs-number">0</span>).multiplyScalar(radius));
        }
  
        <span class="hljs-keyword">return</span> geometry;
      };
  
      <span class="hljs-keyword">this</span>.handleGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Line(<span class="hljs-keyword">new</span> CircleGeometry(<span class="hljs-number">1</span>, <span class="hljs-string">'x'</span>, <span class="hljs-number">0.5</span>), <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0xff0000</span>
          }))]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Line(<span class="hljs-keyword">new</span> CircleGeometry(<span class="hljs-number">1</span>, <span class="hljs-string">'y'</span>, <span class="hljs-number">0.5</span>), <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x00ff00</span>
          }))]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Line(<span class="hljs-keyword">new</span> CircleGeometry(<span class="hljs-number">1</span>, <span class="hljs-string">'z'</span>, <span class="hljs-number">0.5</span>), <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x0000ff</span>
          }))]
     ],
        E: [
      [<span class="hljs-keyword">new</span> THREE.Line(<span class="hljs-keyword">new</span> CircleGeometry(<span class="hljs-number">1.25</span>, <span class="hljs-string">'z'</span>, <span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0xcccc00</span>
          }))]
     ],
        XYZE: [
      [<span class="hljs-keyword">new</span> THREE.Line(<span class="hljs-keyword">new</span> CircleGeometry(<span class="hljs-number">1</span>, <span class="hljs-string">'z'</span>, <span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x787878</span>
          }))]
     ]
      };
  
      <span class="hljs-keyword">this</span>.pickerGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.TorusGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">12</span>, <span class="hljs-built_in">Math</span>.PI), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff0000</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.TorusGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">12</span>, <span class="hljs-built_in">Math</span>.PI), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.TorusGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">12</span>, <span class="hljs-built_in">Math</span>.PI), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x0000ff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]]
     ],
        E: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.TorusGeometry(<span class="hljs-number">1.25</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">2</span>, <span class="hljs-number">24</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          }))]
     ],
        XYZE: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.Geometry())] <span class="hljs-comment">// TODO</span>
     ]
      };
  
      <span class="hljs-keyword">this</span>.setActivePlane = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(axis)</span> </span>{
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'E'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XYZE'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'X'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Y'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Z'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
  
        <span class="hljs-keyword">this</span>.hide();
        <span class="hljs-keyword">this</span>.show();
  
      };
  
      <span class="hljs-keyword">this</span>.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rotation, eye2)</span> </span>{
  
        THREE.TransformGizmo.prototype.update.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  
        <span class="hljs-keyword">var</span> group = {
          handles: <span class="hljs-keyword">this</span>[<span class="hljs-string">'handles'</span>],
          pickers: <span class="hljs-keyword">this</span>[<span class="hljs-string">'pickers'</span>]
        };
  
        <span class="hljs-keyword">var</span> tempMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
        <span class="hljs-keyword">var</span> worldRotation = <span class="hljs-keyword">new</span> THREE.Euler(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> tempQuaternion = <span class="hljs-keyword">new</span> THREE.Quaternion();
        <span class="hljs-keyword">var</span> unitX = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> unitY = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> unitZ = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> quaternionX = <span class="hljs-keyword">new</span> THREE.Quaternion();
        <span class="hljs-keyword">var</span> quaternionY = <span class="hljs-keyword">new</span> THREE.Quaternion();
        <span class="hljs-keyword">var</span> quaternionZ = <span class="hljs-keyword">new</span> THREE.Quaternion();
        <span class="hljs-keyword">var</span> eye = eye2.clone();
  
        worldRotation.copy(<span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>].rotation);
        tempQuaternion.setFromEuler(worldRotation);
  
        tempMatrix.makeRotationFromQuaternion(tempQuaternion).getInverse(tempMatrix);
        eye.applyMatrix4(tempMatrix);
  
        <span class="hljs-keyword">this</span>.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
  
          tempQuaternion.setFromEuler(worldRotation);
  
          <span class="hljs-keyword">if</span> (child.name == <span class="hljs-string">'X'</span>) {
            quaternionX.setFromAxisAngle(unitX, <span class="hljs-built_in">Math</span>.atan2(-eye.y, eye.z));
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionX);
            child.quaternion.copy(tempQuaternion);
          }
  
          <span class="hljs-keyword">if</span> (child.name == <span class="hljs-string">'Y'</span>) {
            quaternionY.setFromAxisAngle(unitY, <span class="hljs-built_in">Math</span>.atan2(eye.x, eye.z));
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionY);
            child.quaternion.copy(tempQuaternion);
          }
  
          <span class="hljs-keyword">if</span> (child.name == <span class="hljs-string">'Z'</span>) {
            quaternionZ.setFromAxisAngle(unitZ, <span class="hljs-built_in">Math</span>.atan2(eye.y, eye.x));
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionZ);
            child.quaternion.copy(tempQuaternion);
          }
  
        });
  
      };
  
      <span class="hljs-keyword">this</span>.init();
  
    };
  
    THREE.TransformGizmoRotate.prototype = <span class="hljs-built_in">Object</span>.create(THREE.TransformGizmo.prototype);
  
    THREE.TransformGizmoScale = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      THREE.TransformGizmo.call(<span class="hljs-keyword">this</span>);
  
      <span class="hljs-keyword">var</span> arrowGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      <span class="hljs-keyword">var</span> mesh = <span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.BoxGeometry(<span class="hljs-number">0.125</span>, <span class="hljs-number">0.125</span>, <span class="hljs-number">0.125</span>));
      mesh.position.y = <span class="hljs-number">0.5</span>;
      mesh.updateMatrix();
  
      arrowGeometry.merge(mesh.geometry, mesh.matrix);
  
      <span class="hljs-keyword">var</span> lineXGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineXGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
  
      <span class="hljs-keyword">var</span> lineYGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineYGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>));
  
      <span class="hljs-keyword">var</span> lineZGeometry = <span class="hljs-keyword">new</span> THREE.Geometry();
      lineZGeometry.vertices.push(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>));
  
      <span class="hljs-keyword">this</span>.handleGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff0000</span>
          })), [<span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineXGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0xff0000</span>
          }))]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ff00</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineYGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x00ff00</span>
          }))]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(arrowGeometry, <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x0000ff</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>], [<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]],
      [<span class="hljs-keyword">new</span> THREE.Line(lineZGeometry, <span class="hljs-keyword">new</span> GizmoLineMaterial({
            color: <span class="hljs-number">0x0000ff</span>
          }))]
     ],
        XYZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.BoxGeometry(<span class="hljs-number">0.125</span>, <span class="hljs-number">0.125</span>, <span class="hljs-number">0.125</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          }))]
     ]
      };
  
      <span class="hljs-keyword">this</span>.pickerGizmos = {
        X: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xff0000</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>]]
     ],
        Y: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x00ff00</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>]]
     ],
        Z: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0x0000ff</span>,
            opacity: <span class="hljs-number">0.25</span>
          })), [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>], [<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]
     ],
        XYZ: [
      [<span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">new</span> THREE.BoxGeometry(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.4</span>), <span class="hljs-keyword">new</span> GizmoMaterial({
            color: <span class="hljs-number">0xffffff</span>,
            opacity: <span class="hljs-number">0.25</span>
          }))]
     ]
      };
  
      <span class="hljs-keyword">this</span>.setActivePlane = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(axis, eye)</span> </span>{
  
        <span class="hljs-keyword">var</span> tempMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
        eye.applyMatrix4(tempMatrix.getInverse(tempMatrix.extractRotation(<span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>].matrixWorld)));
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'X'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.y) &gt; <span class="hljs-built_in">Math</span>.abs(eye.z)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Y'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XY'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.x) &gt; <span class="hljs-built_in">Math</span>.abs(eye.z)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'Z'</span>) {
          <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XZ'</span>];
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(eye.x) &gt; <span class="hljs-built_in">Math</span>.abs(eye.y)) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'YZ'</span>];
        }
  
        <span class="hljs-keyword">if</span> (axis == <span class="hljs-string">'XYZ'</span>) <span class="hljs-keyword">this</span>.activePlane = <span class="hljs-keyword">this</span>.planes[<span class="hljs-string">'XYZE'</span>];
  
        <span class="hljs-keyword">this</span>.hide();
        <span class="hljs-keyword">this</span>.show();
  
      };
  
      <span class="hljs-keyword">this</span>.init();
  
    };
  
    THREE.TransformGizmoScale.prototype = <span class="hljs-built_in">Object</span>.create(THREE.TransformGizmo.prototype);
  
    THREE.TransformControls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(camera, domElement)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>TODO: Make non-uniform scale and rotate play nice in hierarchies
TODO: ADD RXYZ contol</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
      THREE.Object3D.call(<span class="hljs-keyword">this</span>);
  
      domElement = (domElement !== <span class="hljs-literal">undefined</span>) ? domElement : <span class="hljs-built_in">document</span>;
  
      <span class="hljs-keyword">this</span>.gizmo = {};
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>] = <span class="hljs-keyword">new</span> THREE.TransformGizmoTranslate();
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>] = <span class="hljs-keyword">new</span> THREE.TransformGizmoRotate();
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>] = <span class="hljs-keyword">new</span> THREE.TransformGizmoScale();
  
      <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>]);
      <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>]);
      <span class="hljs-keyword">this</span>.add(<span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>]);
  
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>].hide();
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>].hide();
      <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>].hide();
  
      <span class="hljs-keyword">this</span>.object = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">this</span>.snap = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.space = <span class="hljs-string">'world'</span>;
      <span class="hljs-keyword">this</span>.size = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">this</span>.axis = <span class="hljs-literal">null</span>;
  
      <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
  
      <span class="hljs-keyword">var</span> _dragging = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> _mode = <span class="hljs-string">'translate'</span>;
      <span class="hljs-keyword">var</span> _plane = <span class="hljs-string">'XY'</span>;
  
      <span class="hljs-keyword">var</span> changeEvent = {
        type: <span class="hljs-string">'change'</span>
      };
  
      <span class="hljs-keyword">var</span> ray = <span class="hljs-keyword">new</span> THREE.Raycaster();
      <span class="hljs-keyword">var</span> projector = <span class="hljs-keyword">new</span> THREE.Projector();
      <span class="hljs-keyword">var</span> pointerVector = <span class="hljs-keyword">new</span> THREE.Vector3();
  
      <span class="hljs-keyword">var</span> point = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> offset = <span class="hljs-keyword">new</span> THREE.Vector3();
  
      <span class="hljs-keyword">var</span> rotation = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> offsetRotation = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> scale = <span class="hljs-number">1</span>;
  
      <span class="hljs-keyword">var</span> lookAtMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
      <span class="hljs-keyword">var</span> eye = <span class="hljs-keyword">new</span> THREE.Vector3();
  
      <span class="hljs-keyword">var</span> tempMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
      <span class="hljs-keyword">var</span> tempVector = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> tempQuaternion = <span class="hljs-keyword">new</span> THREE.Quaternion();
      <span class="hljs-keyword">var</span> unitX = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> unitY = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> unitZ = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  
      <span class="hljs-keyword">var</span> quaternionXYZ = <span class="hljs-keyword">new</span> THREE.Quaternion();
      <span class="hljs-keyword">var</span> quaternionX = <span class="hljs-keyword">new</span> THREE.Quaternion();
      <span class="hljs-keyword">var</span> quaternionY = <span class="hljs-keyword">new</span> THREE.Quaternion();
      <span class="hljs-keyword">var</span> quaternionZ = <span class="hljs-keyword">new</span> THREE.Quaternion();
      <span class="hljs-keyword">var</span> quaternionE = <span class="hljs-keyword">new</span> THREE.Quaternion();
  
      <span class="hljs-keyword">var</span> oldPosition = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> oldScale = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> oldRotationMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
  
      <span class="hljs-keyword">var</span> parentRotationMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
      <span class="hljs-keyword">var</span> parentScale = <span class="hljs-keyword">new</span> THREE.Vector3();
  
      <span class="hljs-keyword">var</span> worldPosition = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> worldRotation = <span class="hljs-keyword">new</span> THREE.Euler();
      <span class="hljs-keyword">var</span> worldRotationMatrix = <span class="hljs-keyword">new</span> THREE.Matrix4();
      <span class="hljs-keyword">var</span> camPosition = <span class="hljs-keyword">new</span> THREE.Vector3();
      <span class="hljs-keyword">var</span> camRotation = <span class="hljs-keyword">new</span> THREE.Euler();</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>domElement.addEventListener( “mousedown”, onPointerDown, false );
domElement.addEventListener( “touchstart”, onPointerDown, false );</p>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>domElement.addEventListener( “mousemove”, onPointerHover, false );
domElement.addEventListener( “touchmove”, onPointerHover, false );</p>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>domElement.addEventListener( “mousemove”, onPointerMove, false );
domElement.addEventListener( “touchmove”, onPointerMove, false );</p>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>domElement.addEventListener( “mouseup”, onPointerUp, false );
domElement.addEventListener( “mouseout”, onPointerUp, false );
domElement.addEventListener( “touchend”, onPointerUp, false );
domElement.addEventListener( “touchcancel”, onPointerUp, false );
domElement.addEventListener( “touchleave”, onPointerUp, false );</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
      <span class="hljs-keyword">this</span>.attach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object)</span> </span>{
  
        scope.object = object;
  
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[_mode].show();
  
        scope.update();
  
      };
  
      <span class="hljs-keyword">this</span>.detach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object)</span> </span>{
  
        scope.object = <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">this</span>.axis = <span class="hljs-literal">undefined</span>;
  
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>].hide();
  
      };
  
      <span class="hljs-keyword">this</span>.disable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object)</span> </span>{
  
        scope.object = <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">this</span>.axis = <span class="hljs-literal">undefined</span>;
  
      };
  
      <span class="hljs-keyword">this</span>.setMode = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mode)</span> </span>{
  
        _mode = mode ? mode : _mode;
  
        <span class="hljs-keyword">if</span> (_mode == <span class="hljs-string">'scale'</span>) scope.space = <span class="hljs-string">'local'</span>;
  
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'translate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'rotate'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[<span class="hljs-string">'scale'</span>].hide();
        <span class="hljs-keyword">this</span>.gizmo[_mode].show();
  
        <span class="hljs-keyword">this</span>.update();
        scope.dispatchEvent(changeEvent);
  
      };
  
      <span class="hljs-keyword">this</span>.setSnap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(snap)</span> </span>{
  
        scope.snap = snap;
  
      };
  
      <span class="hljs-keyword">this</span>.setSize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(size)</span> </span>{
  
        scope.size = size;
        <span class="hljs-keyword">this</span>.update();
        scope.dispatchEvent(changeEvent);
  
      };
  
      <span class="hljs-keyword">this</span>.setSpace = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(space)</span> </span>{
  
        scope.space = space;
        <span class="hljs-keyword">this</span>.update();
        scope.dispatchEvent(changeEvent);
  
      };
  
      <span class="hljs-keyword">this</span>.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
        <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;
  
        scope.object.updateMatrixWorld();
        worldPosition.setFromMatrixPosition(scope.object.matrixWorld);
        worldRotation.setFromRotationMatrix(tempMatrix.extractRotation(scope.object.matrixWorld));
  
        camera.updateMatrixWorld();
        camPosition.setFromMatrixPosition(camera.matrixWorld);
        camRotation.setFromRotationMatrix(tempMatrix.extractRotation(camera.matrixWorld));
  
        scale = worldPosition.distanceTo(camPosition) / <span class="hljs-number">6</span> * scope.size;
        <span class="hljs-keyword">this</span>.position.copy(worldPosition);
        <span class="hljs-keyword">this</span>.scale.set(scale, scale, scale);
  
        eye.copy(camPosition).sub(worldPosition).normalize();
  
        <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'local'</span>)
          <span class="hljs-keyword">this</span>.gizmo[_mode].update(worldRotation, eye);
  
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'world'</span>)
          <span class="hljs-keyword">this</span>.gizmo[_mode].update(<span class="hljs-keyword">new</span> THREE.Euler(), eye);
  
        <span class="hljs-keyword">this</span>.gizmo[_mode].highlight(scope.axis);
  
      };
  
      <span class="hljs-keyword">this</span>.onPointerHover = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
        <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || _dragging === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        event.preventDefault();
  
        <span class="hljs-keyword">var</span> pointer = event.changedTouches ? event.changedTouches[<span class="hljs-number">0</span>] : event;
  
        <span class="hljs-keyword">var</span> intersect = intersectObjects(pointer, scope.gizmo[_mode].pickers.children);
  
        <span class="hljs-keyword">if</span> (intersect) {
  
          scope.axis = intersect.object.name;
          scope.update();
          scope.dispatchEvent(changeEvent);
  
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.axis !== <span class="hljs-literal">null</span>) {
  
          scope.axis = <span class="hljs-literal">null</span>;
          scope.update();
          scope.dispatchEvent(changeEvent);
  
        }
  
      };
  
      <span class="hljs-keyword">this</span>.onPointerDown = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
        <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || _dragging === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span>;
  
        event.preventDefault();
        event.stopPropagation();
  
        <span class="hljs-keyword">var</span> pointer = event.changedTouches ? event.changedTouches[<span class="hljs-number">0</span>] : event;
  
        <span class="hljs-keyword">if</span> (pointer.button === <span class="hljs-number">0</span> || pointer.button === <span class="hljs-literal">undefined</span>) {
  
          <span class="hljs-keyword">var</span> intersect = intersectObjects(pointer, scope.gizmo[_mode].pickers.children);
  
          <span class="hljs-keyword">if</span> (intersect) {
  
            scope.axis = intersect.object.name;
  
            scope.update();
  
            eye.copy(camPosition).sub(worldPosition).normalize();
  
            scope.gizmo[_mode].setActivePlane(scope.axis, eye);
  
            <span class="hljs-keyword">var</span> planeIntersect = intersectObjects(pointer, [scope.gizmo[_mode].activePlane]);
  
            oldPosition.copy(scope.object.position);
            oldScale.copy(scope.object.scale);
  
            oldRotationMatrix.extractRotation(scope.object.matrix);
            worldRotationMatrix.extractRotation(scope.object.matrixWorld);
  
            parentRotationMatrix.extractRotation(scope.object.parent.matrixWorld);
            parentScale.setFromMatrixScale(tempMatrix.getInverse(scope.object.parent.matrixWorld));
  
            offset.copy(planeIntersect.point);
  
          }
  
        }
  
        _dragging = <span class="hljs-literal">true</span>;
  
      };
  
      <span class="hljs-keyword">this</span>.onPointerMove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
        <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || scope.axis === <span class="hljs-literal">null</span> || _dragging === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
  
        event.preventDefault();
        event.stopPropagation();
  
        <span class="hljs-keyword">var</span> pointer = event.changedTouches ? event.changedTouches[<span class="hljs-number">0</span>] : event;
  
        <span class="hljs-keyword">var</span> planeIntersect = intersectObjects(pointer, [scope.gizmo[_mode].activePlane]);
  
        point.copy(planeIntersect.point);
  
        <span class="hljs-keyword">if</span> (_mode == <span class="hljs-string">'translate'</span>) {
  
          point.sub(offset);
          point.multiply(parentScale);
  
          <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'local'</span>) {
  
            point.applyMatrix4(tempMatrix.getInverse(worldRotationMatrix));
  
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'X'</span>) == -<span class="hljs-number">1</span>) point.x = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Y'</span>) == -<span class="hljs-number">1</span>) point.y = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Z'</span>) == -<span class="hljs-number">1</span>) point.z = <span class="hljs-number">0</span>;
  
            point.applyMatrix4(oldRotationMatrix);
  
            scope.object.position.copy(oldPosition);
            scope.object.position.add(point);
  
          }
  
          <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'world'</span> || scope.axis.search(<span class="hljs-string">'XYZ'</span>) != -<span class="hljs-number">1</span>) {
  
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'X'</span>) == -<span class="hljs-number">1</span>) point.x = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Y'</span>) == -<span class="hljs-number">1</span>) point.y = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Z'</span>) == -<span class="hljs-number">1</span>) point.z = <span class="hljs-number">0</span>;
  
            point.applyMatrix4(tempMatrix.getInverse(parentRotationMatrix));
  
            scope.object.position.copy(oldPosition);
            scope.object.position.add(point);
  
          }
  
          <span class="hljs-keyword">if</span> (scope.snap !== <span class="hljs-literal">null</span>) {
  
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'X'</span>) != -<span class="hljs-number">1</span>) scope.object.position.x = <span class="hljs-built_in">Math</span>.round(scope.object.position.x / scope.snap) * scope.snap;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Y'</span>) != -<span class="hljs-number">1</span>) scope.object.position.y = <span class="hljs-built_in">Math</span>.round(scope.object.position.y / scope.snap) * scope.snap;
            <span class="hljs-keyword">if</span> (scope.axis.search(<span class="hljs-string">'Z'</span>) != -<span class="hljs-number">1</span>) scope.object.position.z = <span class="hljs-built_in">Math</span>.round(scope.object.position.z / scope.snap) * scope.snap;
  
          }
  
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_mode == <span class="hljs-string">'scale'</span>) {
  
          point.sub(offset);
          point.multiply(parentScale);
  
          <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'local'</span>) {
  
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'XYZ'</span>) {
  
              scale = <span class="hljs-number">1</span> + ((point.y) / <span class="hljs-number">50</span>);
  
              scope.object.scale.x = oldScale.x * scale;
              scope.object.scale.y = oldScale.y * scale;
              scope.object.scale.z = oldScale.z * scale;
  
            }
            <span class="hljs-keyword">else</span> {
  
              point.applyMatrix4(tempMatrix.getInverse(worldRotationMatrix));
  
              <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'X'</span>) scope.object.scale.x = oldScale.x * (<span class="hljs-number">1</span> + point.x / <span class="hljs-number">50</span>);
              <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Y'</span>) scope.object.scale.y = oldScale.y * (<span class="hljs-number">1</span> + point.y / <span class="hljs-number">50</span>);
              <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Z'</span>) scope.object.scale.z = oldScale.z * (<span class="hljs-number">1</span> + point.z / <span class="hljs-number">50</span>);
  
            }
  
          }
  
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_mode == <span class="hljs-string">'rotate'</span>) {
  
          point.sub(worldPosition);
          point.multiply(parentScale);
          tempVector.copy(offset).sub(worldPosition);
          tempVector.multiply(parentScale);
  
          <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'E'</span>) {
  
            point.applyMatrix4(tempMatrix.getInverse(lookAtMatrix));
            tempVector.applyMatrix4(tempMatrix.getInverse(lookAtMatrix));
  
            rotation.set(<span class="hljs-built_in">Math</span>.atan2(point.z, point.y), <span class="hljs-built_in">Math</span>.atan2(point.x, point.z), <span class="hljs-built_in">Math</span>.atan2(point.y, point.x));
            offsetRotation.set(<span class="hljs-built_in">Math</span>.atan2(tempVector.z, tempVector.y), <span class="hljs-built_in">Math</span>.atan2(tempVector.x, tempVector.z), <span class="hljs-built_in">Math</span>.atan2(tempVector.y, tempVector.x));
  
            tempQuaternion.setFromRotationMatrix(tempMatrix.getInverse(parentRotationMatrix));
  
            quaternionE.setFromAxisAngle(eye, rotation.z - offsetRotation.z);
            quaternionXYZ.setFromRotationMatrix(worldRotationMatrix);
  
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionE);
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionXYZ);
  
            scope.object.quaternion.copy(tempQuaternion);
  
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'XYZE'</span>) {
  
            quaternionE.setFromEuler(point.clone().cross(tempVector).normalize()); <span class="hljs-comment">// rotation axis</span>
  
            tempQuaternion.setFromRotationMatrix(tempMatrix.getInverse(parentRotationMatrix));
            quaternionX.setFromAxisAngle(quaternionE, -point.clone().angleTo(tempVector));
            quaternionXYZ.setFromRotationMatrix(worldRotationMatrix);
  
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionX);
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionXYZ);
  
            scope.object.quaternion.copy(tempQuaternion);
  
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'local'</span>) {
  
            point.applyMatrix4(tempMatrix.getInverse(worldRotationMatrix));
  
            tempVector.applyMatrix4(tempMatrix.getInverse(worldRotationMatrix));
  
            rotation.set(<span class="hljs-built_in">Math</span>.atan2(point.z, point.y), <span class="hljs-built_in">Math</span>.atan2(point.x, point.z), <span class="hljs-built_in">Math</span>.atan2(point.y, point.x));
            offsetRotation.set(<span class="hljs-built_in">Math</span>.atan2(tempVector.z, tempVector.y), <span class="hljs-built_in">Math</span>.atan2(tempVector.x, tempVector.z), <span class="hljs-built_in">Math</span>.atan2(tempVector.y, tempVector.x));
  
            quaternionXYZ.setFromRotationMatrix(oldRotationMatrix);
            quaternionX.setFromAxisAngle(unitX, rotation.x - offsetRotation.x);
            quaternionY.setFromAxisAngle(unitY, rotation.y - offsetRotation.y);
            quaternionZ.setFromAxisAngle(unitZ, rotation.z - offsetRotation.z);
  
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'X'</span>) quaternionXYZ.multiplyQuaternions(quaternionXYZ, quaternionX);
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Y'</span>) quaternionXYZ.multiplyQuaternions(quaternionXYZ, quaternionY);
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Z'</span>) quaternionXYZ.multiplyQuaternions(quaternionXYZ, quaternionZ);
  
            scope.object.quaternion.copy(quaternionXYZ);
  
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scope.space == <span class="hljs-string">'world'</span>) {
  
            rotation.set(<span class="hljs-built_in">Math</span>.atan2(point.z, point.y), <span class="hljs-built_in">Math</span>.atan2(point.x, point.z), <span class="hljs-built_in">Math</span>.atan2(point.y, point.x));
            offsetRotation.set(<span class="hljs-built_in">Math</span>.atan2(tempVector.z, tempVector.y), <span class="hljs-built_in">Math</span>.atan2(tempVector.x, tempVector.z), <span class="hljs-built_in">Math</span>.atan2(tempVector.y, tempVector.x));
  
            tempQuaternion.setFromRotationMatrix(tempMatrix.getInverse(parentRotationMatrix));
  
            quaternionX.setFromAxisAngle(unitX, rotation.x - offsetRotation.x);
            quaternionY.setFromAxisAngle(unitY, rotation.y - offsetRotation.y);
            quaternionZ.setFromAxisAngle(unitZ, rotation.z - offsetRotation.z);
            quaternionXYZ.setFromRotationMatrix(worldRotationMatrix);
  
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'X'</span>) tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionX);
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Y'</span>) tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionY);
            <span class="hljs-keyword">if</span> (scope.axis == <span class="hljs-string">'Z'</span>) tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionZ);
  
            tempQuaternion.multiplyQuaternions(tempQuaternion, quaternionXYZ);
  
            scope.object.quaternion.copy(tempQuaternion);
  
          }
  
        }
  
        scope.update();
        scope.dispatchEvent(changeEvent);
  
      };
  
      <span class="hljs-keyword">this</span>.onPointerUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
        _dragging = <span class="hljs-literal">false</span>;
        scope.onPointerHover(event);
  
      };
  
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">intersectObjects</span><span class="hljs-params">(pointer, objects)</span> </span>{
  
        <span class="hljs-keyword">var</span> rect = domElement.getBoundingClientRect();
        <span class="hljs-keyword">var</span> x = (pointer.clientX - rect.left) / rect.width;
        <span class="hljs-keyword">var</span> y = (pointer.clientY - rect.top) / rect.height;
        pointerVector.set((x) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>, -(y) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>);
  
        projector.unprojectVector(pointerVector, camera);
        ray.set(camPosition, pointerVector.sub(camPosition).normalize());
  
        <span class="hljs-keyword">var</span> intersections = ray.intersectObjects(objects, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> intersections[<span class="hljs-number">0</span>] ? intersections[<span class="hljs-number">0</span>] : <span class="hljs-literal">false</span>;
  
      }
  
      <span class="hljs-keyword">this</span>.isDragging = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
        <span class="hljs-keyword">return</span> !(scope.object === <span class="hljs-literal">undefined</span> || scope.axis === <span class="hljs-literal">null</span> || _dragging === <span class="hljs-literal">false</span>);
  
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>figure out if an event will intersect a control for a particular callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.eventIntersectsControl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callbackName, event)</span> </span>{
  
        <span class="hljs-keyword">var</span> pointer = event.changedTouches ? event.changedTouches[<span class="hljs-number">0</span>] : event;
  
        <span class="hljs-keyword">var</span> eventMap = {
  
          onPointerHover: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
            <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || _dragging === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
            <span class="hljs-keyword">var</span> intersect = intersectObjects(pointer, scope.gizmo[_mode].pickers.children);
  
            <span class="hljs-keyword">return</span> intersect;
  
          },
  
          onPointerDown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
            <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || _dragging === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
            <span class="hljs-keyword">if</span> (pointer.button === <span class="hljs-number">0</span> || pointer.button === <span class="hljs-literal">undefined</span>) {
  
              <span class="hljs-keyword">var</span> intersect = intersectObjects(pointer, scope.gizmo[_mode].pickers.children);
  
              <span class="hljs-keyword">if</span> (intersect) {
  
                scope.axis = intersect.object.name;
  
                scope.update();
  
                eye.copy(camPosition).sub(worldPosition).normalize();
  
                scope.gizmo[_mode].setActivePlane(scope.axis, eye);
  
                <span class="hljs-keyword">var</span> planeIntersect = intersectObjects(pointer, [scope.gizmo[_mode].activePlane]);
  
                <span class="hljs-keyword">return</span> planeIntersect;
  
              }
              <span class="hljs-keyword">else</span> {
  
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
              }
  
            }
            <span class="hljs-keyword">else</span> {
  
              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
            }
  
          },
  
          onPointerMove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
  
            <span class="hljs-keyword">if</span> (scope.object === <span class="hljs-literal">undefined</span> || scope.axis === <span class="hljs-literal">null</span> || _dragging === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
            <span class="hljs-keyword">var</span> planeIntersect = intersectObjects(pointer, [scope.gizmo[_mode].activePlane]);
  
            <span class="hljs-keyword">return</span> planeIntersect;
  
          }
  
        };
  
        <span class="hljs-keyword">return</span> eventMap[callbackName] &amp;&amp; eventMap[callbackName](event);
  
      };
  
    };
  
    THREE.TransformControls.prototype = <span class="hljs-built_in">Object</span>.create(THREE.Object3D.prototype);
  
  }());</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h1 id="general-utilities">General utilities</h1>
<p>creates instances</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> construct = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(constructor, args)</span> </span>{
    <span class="hljs-keyword">var</span> f = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> constructor.apply(<span class="hljs-keyword">this</span>, args);
    };
    f.prototype = constructor.prototype;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> f();
  };
  
  <span class="hljs-keyword">var</span> capitalise = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(string)</span> </span>{
    <span class="hljs-keyword">return</span> string &amp;&amp; string.charAt(<span class="hljs-number">0</span>).toUpperCase() + string.slice(<span class="hljs-number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h1 id="models">Models</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> Drawable = m3js.Drawable = Backbone.Model.extend({
  
    defaults: {
      texture: <span class="hljs-string">'/img/crate.gif'</span>,
      geometryType: <span class="hljs-string">'BoxGeometry'</span>,
      geometryParams: [<span class="hljs-number">200</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>],
      matrix: [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]
    },
  
    _mesh: <span class="hljs-literal">undefined</span>,
    _texture: <span class="hljs-literal">undefined</span>,
    _material: <span class="hljs-literal">undefined</span>,
    _geometry: <span class="hljs-literal">undefined</span>,
  
    initDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
  
      <span class="hljs-keyword">var</span> _loaded = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (_this.collection !== <span class="hljs-literal">undefined</span>) {
          _this.collection.trigger(<span class="hljs-string">'drawable:loaded'</span>, _this);
        }
        _this.trigger(<span class="hljs-string">'drawable:loaded'</span>, _this);
  
        _this.on(<span class="hljs-string">'change:matrix'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
          _this.updateMesh();
        });
        _this.updateMesh();
      };
  
      <span class="hljs-keyword">if</span> (THREE.hasOwnProperty(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'geometryType'</span>))) {
        <span class="hljs-keyword">this</span>._texture = THREE.ImageUtils.loadTexture(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'texture'</span>), <span class="hljs-keyword">new</span> THREE.UVMapping(), _loaded);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>this._texture.anisotropy = window._renderer.renderer.getMaxAnisotropy();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._geometry = construct(THREE[<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'geometryType'</span>)], <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'geometryParams'</span>));
        <span class="hljs-keyword">this</span>._material = <span class="hljs-keyword">new</span> THREE.MeshLambertMaterial({
          map: <span class="hljs-keyword">this</span>._texture
        });
  
        <span class="hljs-keyword">this</span>._mesh = <span class="hljs-keyword">new</span> THREE.Mesh(<span class="hljs-keyword">this</span>._geometry, <span class="hljs-keyword">this</span>._material);
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'Drawable: no compatible geometry type'</span>);
      }
    },
  
    updateMesh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._mesh.matrix.set.apply(<span class="hljs-keyword">this</span>._mesh.matrix, <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'matrix'</span>));
      <span class="hljs-keyword">this</span>._mesh.matrix.decompose(<span class="hljs-keyword">this</span>._mesh.position, <span class="hljs-keyword">this</span>._mesh.quaternion, <span class="hljs-keyword">this</span>._mesh.scale);
    },
  
    getMesh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._mesh;
    },
  
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">this</span>.initDrawable();
    }
  });
  
  <span class="hljs-keyword">var</span> OrbitControl = m3js.OrbitControl = Backbone.Model.extend({
  
    _control: <span class="hljs-literal">undefined</span>,
  
    initializeControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
  
      <span class="hljs-keyword">this</span>._control = <span class="hljs-keyword">new</span> THREE.OrbitControls(<span class="hljs-keyword">this</span>.renderer.camera);
      <span class="hljs-keyword">this</span>._control.damping = <span class="hljs-number">0.1</span>;
    },
  
    getControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._control;
    },
  
    disable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._control.enabled = <span class="hljs-literal">false</span>;
    },
  
    enable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._control.enabled = <span class="hljs-literal">true</span>;
    },
  
    isEnabled: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._control.enabled;
    },
  
    dispatchDOMEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">var</span> eventMap = {
        <span class="hljs-string">'contextmenu'</span>: <span class="hljs-string">'onContextMenu'</span>,
        <span class="hljs-string">'mousedown'</span>: <span class="hljs-string">'onMouseDown'</span>,
        <span class="hljs-string">'mousewheel'</span>: <span class="hljs-string">'onMouseWheel'</span>,
        <span class="hljs-string">'DOMMouseScroll'</span>: <span class="hljs-string">'onMouseWheel'</span>,
  
        <span class="hljs-string">'touchstart'</span>: <span class="hljs-string">'touchstart'</span>,
        <span class="hljs-string">'touchend'</span>: <span class="hljs-string">'touchend'</span>,
        <span class="hljs-string">'touchmove'</span>: <span class="hljs-string">'touchmove'</span>,
  
        <span class="hljs-string">'keydown'</span>: <span class="hljs-string">'onKeyDown'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>orbit controls dynamically attach and remove these as part of dragging
‘mousemove’: ‘onMouseMove’,
‘mouseup’: ‘onMouseUp’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      };
  
      <span class="hljs-keyword">if</span> (eventMap[e.type] &amp;&amp; _.isFunction(<span class="hljs-keyword">this</span>._control[eventMap[e.type]])) {
        <span class="hljs-keyword">this</span>._control[eventMap[e.type]].call(<span class="hljs-keyword">this</span>._control, e);
      }
    },
  
    renderer: <span class="hljs-literal">undefined</span>,
  
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">this</span>.renderer = options.renderer;
      <span class="hljs-keyword">this</span>.initializeControl();
    }
  });
  
  <span class="hljs-keyword">var</span> TransformControl = m3js.TransformControl = Backbone.Model.extend({
  
    defaults: {
      attachedDrawable: <span class="hljs-literal">undefined</span>,
  
      mode: <span class="hljs-string">'translate'</span>, <span class="hljs-comment">// translate, rotate or scale</span>
      space: <span class="hljs-string">'local'</span> <span class="hljs-comment">// local or world</span>
    },
  
    _control: <span class="hljs-literal">undefined</span>,
  
    initializeControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
  
      <span class="hljs-keyword">this</span>._control = <span class="hljs-keyword">new</span> THREE.TransformControls(<span class="hljs-keyword">this</span>.renderer.camera, <span class="hljs-keyword">this</span>.renderer.renderer.domElement);
  
      <span class="hljs-keyword">this</span>._control.addEventListener(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  
        <span class="hljs-keyword">var</span> drawable = _this.get(<span class="hljs-string">'attachedDrawable'</span>);
        <span class="hljs-keyword">var</span> elementsFloat32Arr = drawable.getMesh().matrix.elements;
        <span class="hljs-keyword">var</span> elements = <span class="hljs-built_in">Array</span>.prototype.slice.call(elementsFloat32Arr);
        <span class="hljs-keyword">var</span> e = elements;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>elements
0 4 8 12 1 5 9 13 2 6 10 14 3 7 11 15</p>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>set: function (n11, n12, n13, n14, n21, n22, n23, n24, n31, n32, n33, n34, n41, n42, n43, n44)
                0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   10,  11,  12,  13,  14,  15</p>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>var te = this.elements;</p>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>te[ 0 ] = n11; te[ 4 ] = n12; te[ 8 ] = n13; te[ 12 ] = n14;
te[ 1 ] = n21; te[ 5 ] = n22; te[ 9 ] = n23; te[ 13 ] = n24;
te[ 2 ] = n31; te[ 6 ] = n32; te[ 10 ] = n33; te[ 14 ] = n34;
te[ 3 ] = n41; te[ 7 ] = n42; te[ 11 ] = n43; te[ 15 ] = n44;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
        <span class="hljs-keyword">var</span> elementsRowMajor = [e[<span class="hljs-number">0</span>], e[<span class="hljs-number">4</span>], e[<span class="hljs-number">8</span>], e[<span class="hljs-number">12</span>], e[<span class="hljs-number">1</span>], e[<span class="hljs-number">5</span>], e[<span class="hljs-number">9</span>], e[<span class="hljs-number">13</span>], e[<span class="hljs-number">2</span>], e[<span class="hljs-number">6</span>], e[<span class="hljs-number">10</span>], e[<span class="hljs-number">14</span>], e[<span class="hljs-number">3</span>], e[<span class="hljs-number">7</span>], e[<span class="hljs-number">11</span>], e[<span class="hljs-number">15</span>]];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>col-major (elements - sanity check): [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 100, 101, 102, 1]
row-major (set - sanity check): [0, ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
        <span class="hljs-keyword">if</span> (!_.isEqual(drawable.get(<span class="hljs-string">'matrix'</span>), elementsRowMajor)) {
          drawable.set(<span class="hljs-string">'matrix'</span>, elementsRowMajor);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>drawable.trigger(‘change:matrix’);
drawable.save({
silent: true
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
      });
  
      _this.renderer.scene.add(_this._control);
    },
  
    getControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._control;
    },
  
    getAttachedDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'attachedDrawable'</span>);
    },
  
    attachDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'attachedDrawable'</span>) !== drawable) {
        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'attachedDrawable'</span>, drawable);
        <span class="hljs-keyword">this</span>._control.attach(drawable.getMesh());
      }
    },
  
    detachDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
      drawable = drawable || <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'attachedDrawable'</span>);
      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'attachedDrawable'</span>, <span class="hljs-literal">undefined</span>);
      <span class="hljs-keyword">if</span> (drawable) {
        <span class="hljs-keyword">this</span>._control.disable(drawable.getMesh());
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'TransformControl: can\'t detach nonexistant drawable'</span>);
      }
    },
  
    hasAttachedDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'attachedDrawable'</span>);
    },
  
    controlEventMap: {
      <span class="hljs-string">'mousedown'</span>: <span class="hljs-string">'onPointerDown'</span>,
      <span class="hljs-string">'touchstart'</span>: <span class="hljs-string">'onPointerDown'</span>,
  
      <span class="hljs-string">'mousemove'</span>: [<span class="hljs-string">'onPointerHover'</span>, <span class="hljs-string">'onPointerMove'</span>],
      <span class="hljs-string">'touchmove'</span>: [<span class="hljs-string">'onPointerHover'</span>, <span class="hljs-string">'onPointerMove'</span>],
  
      <span class="hljs-string">'mouseup'</span>: <span class="hljs-string">'onPointerUp'</span>,
      <span class="hljs-string">'mouseout'</span>: <span class="hljs-string">'onPointerUp'</span>,
      <span class="hljs-string">'touchend'</span>: <span class="hljs-string">'onPointerUp'</span>,
      <span class="hljs-string">'touchcancel'</span>: <span class="hljs-string">'onPointerUp'</span>,
      <span class="hljs-string">'touchleave'</span>: <span class="hljs-string">'onPointerUp'</span>
    },
  
    dispatchDOMEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> handlers = <span class="hljs-keyword">this</span>.controlEventMap[e.type];
      <span class="hljs-keyword">var</span> handlerNames = _.isArray(handlers) ? handlers : [handlers];
      handlerNames.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handlerName)</span> </span>{
        <span class="hljs-keyword">if</span> (_this._control[handlerName]) {
          _this._control[handlerName].call(_this._control, e);
        }
      });
    },
  
    intersectsControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> handlers = <span class="hljs-keyword">this</span>.controlEventMap[e.type];
      <span class="hljs-keyword">var</span> handlerNames = _.isArray(handlers) ? handlers : [handlers];
      <span class="hljs-keyword">var</span> ret;
      handlerNames.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handlerName, i)</span> </span>{
        <span class="hljs-keyword">var</span> intersects = _this._control.eventIntersectsControl(handlerName, e);
        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) {
          ret = intersects;
        }
        <span class="hljs-keyword">else</span> {
          ret = ret || intersects;
        }
      });
      <span class="hljs-keyword">return</span> ret;
    },
  
    isDragging: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._control.isDragging();
    },
  
    renderer: <span class="hljs-literal">undefined</span>,
  
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">this</span>.renderer = options.renderer;
      <span class="hljs-keyword">this</span>.initializeControl();
  
      <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'change:mode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>._control.setMode(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'mode'</span>));
      });
  
      <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'change:space'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>._control.setSpace(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'space'</span>));
      });
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <h1 id="views">Views</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> ThreeJSRenderer = m3js.ThreeJSRenderer = Marionette.ItemView.extend({
  
    template: _.template(<span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span>),
  
    collectionEvents: {
      <span class="hljs-string">'remove'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
        <span class="hljs-keyword">this</span>.removeDrawable(drawable);
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>this basically takes the place of the add event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'drawable:loaded'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
        <span class="hljs-keyword">this</span>.addDrawable(drawable);
      }
    },
  
    _transformControlDragging: <span class="hljs-literal">false</span>,
  
    onPointerDown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    onPointerHover: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    onPointerMove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    onPointerUp: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
  
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._transformControlDragging) {
        <span class="hljs-keyword">var</span> searchList = [];
        <span class="hljs-keyword">this</span>.collection.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> </span>{
          <span class="hljs-keyword">var</span> baseMesh = model.getMesh();
          <span class="hljs-keyword">if</span> (baseMesh) {
            <span class="hljs-keyword">var</span> meshes = [];
            baseMesh.traverse(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mesh)</span> </span>{
              <span class="hljs-keyword">if</span> (mesh) {
                meshes.push(mesh);
              }
            });
            meshes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mesh)</span> </span>{
              searchList.push({
                drawable: model,
                mesh: mesh
              });
            });
          }
        });
  
        <span class="hljs-keyword">this</span>._raycast({
          event: e,
          callback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(intersections)</span> </span>{
  
            <span class="hljs-keyword">var</span> raycastedDrawable;
            <span class="hljs-keyword">if</span> (intersections[<span class="hljs-number">0</span>]) {
              raycastedDrawable = _.findWhere(searchList, {
                mesh: intersections[<span class="hljs-number">0</span>].object
              }).drawable;
            }
  
            <span class="hljs-keyword">if</span> (raycastedDrawable) {
              <span class="hljs-keyword">this</span>.transformControl.attachDrawable(raycastedDrawable);
            }
          }
        });
      }
    },
  
    onMouseWheel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    onKeyDown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    onContextMenu: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">this</span>.dispatchDOMEventToControls(e);
    },
  
    getWidth: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.innerWidth - <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'div'</span>).offset().left - <span class="hljs-number">1.0</span>;
    },
  
    getHeight: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.innerHeight - <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'div'</span>).offset().top - <span class="hljs-number">5.25</span>; <span class="hljs-comment">// why?</span>
    },
  
    camera: <span class="hljs-literal">undefined</span>,
    scene: <span class="hljs-literal">undefined</span>,
    renderer: <span class="hljs-literal">undefined</span>,
  
    setupRenderer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.renderer = <span class="hljs-keyword">new</span> THREE.WebGLRenderer({
        precision: <span class="hljs-string">'highp'</span>,
        antialias: <span class="hljs-literal">true</span>
      });
      <span class="hljs-keyword">this</span>.renderer.sortObjects = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.renderer.setSize(<span class="hljs-keyword">this</span>.getWidth(), <span class="hljs-keyword">this</span>.getHeight());
  
      <span class="hljs-keyword">this</span>.renderer.setClearColor(<span class="hljs-number">0xaaaaaa</span>);
  
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> _setRendererDOMElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        _this.$el.find(<span class="hljs-string">'div'</span>).append(_this.renderer.domElement);
      };
      _setRendererDOMElement();
      <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'render'</span>, _setRendererDOMElement);
    },
  
    setupCamera: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.camera = <span class="hljs-keyword">new</span> THREE.PerspectiveCamera(<span class="hljs-number">70</span>, <span class="hljs-keyword">this</span>.getWidth() / <span class="hljs-keyword">this</span>.getHeight(), <span class="hljs-number">0.01</span>, <span class="hljs-number">10000.0</span>);
      <span class="hljs-keyword">this</span>.camera.position.set(<span class="hljs-number">1000</span>, <span class="hljs-number">500</span>, <span class="hljs-number">1000</span>);
      <span class="hljs-keyword">this</span>.camera.lookAt(<span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">0</span>));
    },
  
    setupScene: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.scene = <span class="hljs-keyword">new</span> THREE.Scene();
  
      <span class="hljs-keyword">var</span> grid = <span class="hljs-keyword">new</span> THREE.GridHelper(<span class="hljs-number">1000</span>, <span class="hljs-number">100</span>);
      grid.setColors(<span class="hljs-number">0x444444</span>, <span class="hljs-number">0x888888</span>);
      <span class="hljs-keyword">this</span>.scene.add(grid);
  
      <span class="hljs-keyword">var</span> light = <span class="hljs-keyword">new</span> THREE.HemisphereLight(<span class="hljs-number">0xFFFFFF</span>, <span class="hljs-number">0x645943</span>);
      light.position.set(<span class="hljs-number">0</span>, <span class="hljs-number">50.0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">this</span>.scene.add(light);
    },
  
    addDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ThreeJSRenderer: add drawable'</span>);
  
      <span class="hljs-keyword">var</span> mesh = drawable.getMesh();
      <span class="hljs-keyword">if</span> (mesh) {
        <span class="hljs-keyword">this</span>.scene.add(mesh);
      }
    },
  
    removeDrawable: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(drawable)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ThreeJSRenderer: remove drawable'</span>);
  
      <span class="hljs-keyword">var</span> mesh = drawable.getMesh();
      <span class="hljs-keyword">if</span> (mesh) {
        <span class="hljs-keyword">this</span>.scene.remove(mesh);
      }
    },
  
    onWindowResize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.camera.aspect = <span class="hljs-keyword">this</span>.getWidth() / <span class="hljs-keyword">this</span>.getHeight();
      <span class="hljs-keyword">this</span>.camera.updateProjectionMatrix();
  
      <span class="hljs-keyword">this</span>.renderer.setSize(<span class="hljs-keyword">this</span>.getWidth(), <span class="hljs-keyword">this</span>.getHeight());
    },
  
    startWebGLRendering: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> _render = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        _this.transformControl.getControl().update();
        _this.renderer.render(_this.scene, _this.camera);
      };
  
      <span class="hljs-keyword">var</span> _animate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        requestAnimationFrame(_animate);
        _render();
      };
      _animate();
    },
  
    pointerVector: <span class="hljs-keyword">new</span> THREE.Vector3(),
    rayCaster: <span class="hljs-keyword">new</span> THREE.Raycaster(),
    projector: <span class="hljs-keyword">new</span> THREE.Projector(),
  
    _raycast: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">var</span> e = options.event;
      <span class="hljs-keyword">var</span> callback = options.callback;
  
      <span class="hljs-keyword">if</span> (!callback) {
        <span class="hljs-keyword">return</span>;
      }
  
      <span class="hljs-keyword">var</span> meshes = [];
      <span class="hljs-keyword">if</span> (!options.meshes) {
        <span class="hljs-keyword">this</span>.collection.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> </span>{
          <span class="hljs-keyword">if</span> (model.getMesh()) {
            meshes.push(model.getMesh());
          }
        });
      }
      <span class="hljs-keyword">else</span> {
        meshes = options.meshes;
      }
  
      <span class="hljs-keyword">var</span> rect = <span class="hljs-keyword">this</span>.renderer.domElement.getBoundingClientRect();
  
      <span class="hljs-keyword">var</span> x = (e.clientX - rect.left) / rect.width;
      <span class="hljs-keyword">var</span> y = (e.clientY - rect.top) / rect.height;
      <span class="hljs-keyword">this</span>.pointerVector.set((x) * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span>, -(y) * <span class="hljs-number">2.0</span> + <span class="hljs-number">1.0</span>, <span class="hljs-number">0.5</span>);
  
      <span class="hljs-keyword">this</span>.projector.unprojectVector(<span class="hljs-keyword">this</span>.pointerVector, <span class="hljs-keyword">this</span>.camera);
      <span class="hljs-keyword">this</span>.rayCaster.set(<span class="hljs-keyword">this</span>.camera.position, <span class="hljs-keyword">this</span>.pointerVector.sub(<span class="hljs-keyword">this</span>.camera.position).normalize());
  
      <span class="hljs-keyword">var</span> intersections = <span class="hljs-keyword">this</span>.rayCaster.intersectObjects(meshes, <span class="hljs-literal">true</span>);
  
      callback.call(<span class="hljs-keyword">this</span>, intersections);
    },
  
    transformControl: <span class="hljs-literal">undefined</span>,
    orbitControl: <span class="hljs-literal">undefined</span>,
  
    setupTransformControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>reuse the same transformControl instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.transformControl) {
        <span class="hljs-keyword">this</span>.transformControl = <span class="hljs-keyword">new</span> TransformControl({
          renderer: <span class="hljs-keyword">this</span>
        });
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'transformcontrols:create'</span>, <span class="hljs-keyword">this</span>.transformControl);
      }
    },
  
    disableTransformControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.transformControl &amp;&amp; <span class="hljs-keyword">this</span>.transformControl.hasAttachedDrawable()) {
        <span class="hljs-keyword">this</span>.transformControl.detachDrawable();
      }
    },
  
    setupOrbitControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>reuse the same orbitControl instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.orbitControl) {
        <span class="hljs-keyword">this</span>.orbitControl = <span class="hljs-keyword">new</span> OrbitControl({
          renderer: <span class="hljs-keyword">this</span>
        });
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.orbitControl.enable();
      }
    },
  
    disableOrbitControl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.orbitControl &amp;&amp; <span class="hljs-keyword">this</span>.orbitControl.isEnabled()) {
        <span class="hljs-keyword">this</span>.orbitControl.disable();
      }
    },
  
    setupPointerEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> domElement = <span class="hljs-keyword">this</span>.renderer.domElement;
      <span class="hljs-keyword">var</span> eventMap = {
        <span class="hljs-string">'mousedown'</span>: <span class="hljs-string">'onPointerDown'</span>,
        <span class="hljs-string">'touchstart'</span>: <span class="hljs-string">'onPointerDown'</span>,
  
        <span class="hljs-string">'mousemove'</span>: [<span class="hljs-string">'onPointerHover'</span>, <span class="hljs-string">'onPointerMove'</span>],
        <span class="hljs-string">'touchmove'</span>: [<span class="hljs-string">'onPointerHover'</span>, <span class="hljs-string">'onPointerMove'</span>],
  
        <span class="hljs-string">'mouseup'</span>: <span class="hljs-string">'onPointerUp'</span>,
        <span class="hljs-string">'mouseout'</span>: <span class="hljs-string">'onPointerUp'</span>,
        <span class="hljs-string">'touchend'</span>: <span class="hljs-string">'onPointerUp'</span>,
        <span class="hljs-string">'touchcancel'</span>: <span class="hljs-string">'onPointerUp'</span>,
        <span class="hljs-string">'touchleave'</span>: <span class="hljs-string">'onPointerUp'</span>,
  
        <span class="hljs-string">'mousewheel'</span>: <span class="hljs-string">'onMouseWheel'</span>,
        <span class="hljs-string">'DOMMouseScroll'</span>: <span class="hljs-string">'onMouseWheel'</span>,
  
        <span class="hljs-string">'keydown'</span>: <span class="hljs-string">'onKeyDown'</span>,
  
        <span class="hljs-string">'contextmenu'</span>: <span class="hljs-string">'onContextMenu'</span>
      };
  
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      _.forEach(eventMap, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handlerName, eventName)</span> </span>{
        <span class="hljs-keyword">var</span> handlerNames = _.isArray(handlerName) ? handlerName : [handlerName];
        handlerNames.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handlerName)</span> </span>{
          domElement.addEventListener(eventName, _this[handlerName].bind(_this), <span class="hljs-literal">false</span>);
        });
      });
    },
  
    dispatchDOMEventToControls: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>only dispatch to orbit control if not intersecting transform control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.transformControl.intersectsControl(e)) {
        <span class="hljs-keyword">this</span>.orbitControl.dispatchDOMEvent(e);
      }
  
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.transformControl) {
        <span class="hljs-keyword">this</span>._transformControlDragging = <span class="hljs-keyword">this</span>.transformControl.isDragging();
        <span class="hljs-keyword">this</span>.transformControl.dispatchDOMEvent(e);
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._transformControlDragging = <span class="hljs-literal">false</span>;
      }
    },
  
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">this</span>.once(<span class="hljs-string">'show'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.setupRenderer();
        <span class="hljs-keyword">this</span>.setupCamera();
        <span class="hljs-keyword">this</span>.setupScene();
  
        <span class="hljs-keyword">this</span>.setupPointerEvents();
  
        <span class="hljs-keyword">this</span>.setupTransformControl();
        <span class="hljs-keyword">this</span>.setupOrbitControl();
  
        <span class="hljs-keyword">this</span>.collection.fetch();
  
        <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'resize'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
          _this.onWindowResize();
        }, <span class="hljs-literal">false</span>);
  
        _this.startWebGLRendering();
        _this.render();
      });
    }
  });
  
  <span class="hljs-keyword">var</span> TransformControlMode = m3js.TransformControlMode = Marionette.ItemView.extend({
  
    templateHelpers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> {
        transformControlSpace: <span class="hljs-keyword">this</span>.transformControl &amp;&amp; capitalise(<span class="hljs-keyword">this</span>.transformControl.get(<span class="hljs-string">'space'</span>))
      };
    },
  
    events: {
      <span class="hljs-string">'click #translate-mode'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">this</span>.transformControl.set(<span class="hljs-string">'mode'</span>, <span class="hljs-string">'translate'</span>);
      },
  
      <span class="hljs-string">'click #rotate-mode'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">this</span>.transformControl.set(<span class="hljs-string">'mode'</span>, <span class="hljs-string">'rotate'</span>);
      },
  
      <span class="hljs-string">'click #scale-mode'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">this</span>.transformControl.set(<span class="hljs-string">'mode'</span>, <span class="hljs-string">'scale'</span>);
      },
  
      <span class="hljs-string">'click #toggle-space'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">var</span> newSpace = <span class="hljs-keyword">this</span>.transformControl.get(<span class="hljs-string">'space'</span>) == <span class="hljs-string">'local'</span> ? <span class="hljs-string">'world'</span> : <span class="hljs-string">'local'</span>;
        <span class="hljs-keyword">this</span>.transformControl.set(<span class="hljs-string">'space'</span>, newSpace);
        <span class="hljs-keyword">this</span>.render();
      }
    },
  
    transformControl: <span class="hljs-literal">undefined</span>,
  
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
      <span class="hljs-keyword">this</span>.transformControl = options.transformControl;
    }
  });
  

  <span class="hljs-keyword">return</span> m3js;

}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
